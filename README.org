#+TITLE: CLatter - A Common Lisp IRC Client
#+AUTHOR: Glenn Thompson
#+OPTIONS: toc:2

* CLatter

A terminal-based IRC client written in Common Lisp using the [[https://codeberg.org/McParen/croatoan][croatoan]] ncurses library.

** Features

- *TLS Support* - Secure connections to IRC servers
- *SASL Authentication* - Authenticate before connection completes (hides IP)
- *Nick Colorization* - Each nick gets a consistent color based on hash
- *Nick Highlighting* - Messages mentioning your nick are highlighted (bold magenta)
- *Tab Completion* - Press Tab to complete nicks in the current channel
- *Autojoin Management* - Channels are auto-added to autojoin on ~/join~
- *Multi-buffer Interface* - Server, channel, and query buffers
- *Command History* - Up/Down arrows to navigate input history
- *Scrollback* - Page Up/Down to scroll through message history
- *Split-Pane View* - View two channels side-by-side (Ctrl-W to toggle)
- *Timestamps* - Configurable time format on messages

** Requirements

- SBCL (Steel Bank Common Lisp)
- Quicklisp
- ncurses development libraries

** Installation

#+begin_src bash
# 1. Install system dependencies
# Debian/Ubuntu:
sudo apt install sbcl libncurses-dev
# Fedora/RHEL:
# sudo dnf install sbcl ncurses-devel
# Arch:
# sudo pacman -S sbcl ncurses

# 2. Install Quicklisp (if not already installed)
curl -O https://beta.quicklisp.org/quicklisp.lisp
sbcl --load quicklisp.lisp \
     --eval '(quicklisp-quickstart:install)' \
     --eval '(ql:add-to-init-file)' \
     --quit
rm quicklisp.lisp

# 3. Clone and build
git clone https://github.com/glenneth1/CLatter.git
cd CLatter
make clean && make
#+end_src

** Usage

#+begin_src bash
./clatter
#+end_src

On first run, you'll be prompted for a nickname and connected to Libera.Chat.

** Configuration

Configuration is stored in =~/.config/clatter/config.lisp=

Example:
#+begin_src lisp
(:clatter-config
 :version 1
 :default-network nil
 :time-format "%H:%M"
 :networks
 ((:name "libera"
   :server "irc.libera.chat"
   :port 6697
   :tls t
   :nick "yournick"
   :username nil
   :realname "Your Name"
   :password nil
   :nickserv-pw nil
   :autojoin ("#lisp" "#emacs")
   :autoconnect t)))
#+end_src

*** Time Format Options

The =:time-format= setting controls how timestamps are displayed on messages.

| Token | Description          | Example |
|-------+----------------------+---------|
| =%H=  | 24-hour hour (00-23) | 14      |
| =%I=  | 12-hour hour (01-12) | 02      |
| =%M=  | Minute (00-59)       | 30      |
| =%S=  | Second (00-59)       | 45      |
| =%p=  | AM/PM indicator      | PM      |

Example formats:
- ="%H:%M"= → =14:30= (default)
- ="%H:%M:%S"= → =14:30:45=
- ="%I:%M %p"= → =02:30 PM=

*** SASL Authentication

SASL authenticates you *before* your connection is visible, so your IP/hostname is cloaked from the start. To enable SASL:

1. You must have a registered nick with NickServ
2. Add =:sasl :plain= to your network config
3. Ensure =:nickserv-pw= contains your NickServ password (or use =:authinfo=)

Example network config with SASL:
#+begin_src lisp
(:name "libera"
 :server "irc.libera.chat"
 :port 6697
 :tls t
 :nick "yournick"
 :nickserv-pw "your-nickserv-password"
 :sasl :plain
 :autojoin ("#channel1" "#channel2")
 :autoconnect t)
#+end_src

*** Authinfo Password Storage

Instead of storing passwords in =config.lisp=, you can use =~/.authinfo= or =~/.authinfo.gpg= (encrypted with GPG). Set =:nickserv-pw :authinfo= in your config:

#+begin_src lisp
(:name "libera"
 :server "irc.libera.chat"
 :nick "yournick"
 :nickserv-pw :authinfo
 :sasl :plain
 ...)
#+end_src

Then add an entry to your =~/.authinfo.gpg= file:
#+begin_example
machine irc.libera.chat login yournick password your-secret-password
#+end_example

CLatter will decrypt the file using GPG and look up the password by matching the server and nick.

** Commands

| Command                      | Description                              |
|------------------------------+------------------------------------------|
| ~/join #channel [key]~       | Join a channel (auto-adds to autojoin)  |
| ~/part [#channel] [msg]~     | Leave a channel                          |
| ~/autojoin~                  | List autojoin channels                   |
| ~/autojoin add #channel~     | Add channel to autojoin                  |
| ~/autojoin remove #channel~  | Remove channel from autojoin             |
| ~/msg target text~           | Send private message                     |
| ~/me action~                 | Send action to current channel           |
| ~/nick newnick~              | Change nickname                          |
| ~/quit~ or ~/q [message]~    | Disconnect and exit                      |
| ~/ns command~                | Send to NickServ                         |
| ~/cs command~                | Send to ChanServ                         |
| ~/query nick~                | Open query with user                     |
| ~/raw line~                  | Send raw IRC command                     |
| ~/help~                      | Show help                                |

** Keybindings

| Key          | Action                              |
|--------------+-------------------------------------|
| Tab          | Nick completion                     |
| Up/Down      | Input history                       |
| Page Up/Down | Scroll chat                         |
| Ctrl-P/N     | Previous/Next buffer (left pane)    |
| Ctrl-A       | Move to start of line               |
| Ctrl-E       | Move to end of line                 |
| Backspace    | Delete character                    |
| Enter        | Send message/command                |
| Ctrl-W       | Toggle split-pane view              |
| Ctrl-R       | Set current buffer as right pane    |
| Ctrl-X       | Swap left and right pane buffers    |
| Ctrl-]       | Toggle active pane (for input)      |

** License

MIT

** Acknowledgments

- [[https://codeberg.org/McParen/croatoan][croatoan]] - ncurses bindings for Common Lisp
- Libera.Chat IRC network
